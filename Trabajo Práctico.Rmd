---
title: "Trabajo Práctico"
subtitle: "CDDPC II - UTDT"
author: "Luis Tisocco & Santiago Soubie"
date: "2° Trimestre 2021"
output: html_document
editor_options: 
  chunk_output_type: inline
---



## Índice


#### [Trabajo Práctico N°1](#tp_1)


#### [Trabajo Práctico N°2](#tp_2)


#### [Trabajo Práctico N°3](#tp_3)


#### [Trabajo Práctico N°4](#tp_4)

--------------------------------------------------------------------------------


### <a id="tp_1"></a>**Trabajo Práctico N°1**



```{r include=FALSE}
sf::sf_use_s2(FALSE)
library(tidyverse)
library(sf)
library(ggmap)
library(scales)
library(leaflet)
options(scipen = 999) #Anula la notación científica
```

### **Introducción**

En el contexto de la actual pandemia de COVID-19 muchos ideales de la planificación urbana se han puesto en duda. Uno de ellos, y quizás el más evidente, tiene que ver con los patrones de uso del suelo de los centros de las grandes ciudades.

Pesando en una posible revitalización urbana y en la incoporación de áreas verdes en zonas densas y consolidadas, nos preguntamos:


    ¿Es posible convertir los estacionamientos concesionados en áreas verdes? 
    ¿Dónde se ubican? ¿Están espacialmente concentrados en el centro?


**Consignas**

1. *Elegir una ciudad de cualquier parte del mundo que les interese (ya que seguirán trabajando con ella a lo largo del curso) y que disponga de un portal de datos abiertos que ofrezca un shapefile (formato geojson o shp) de polígonos con alguna división geográfica: barrios, comunas, etc.*

En este trabajo elegiremos a la *Ciudad Autónoma de Buenos Aires (CABA)* como objeto de estudio.

Nuestro primer paso será cargar los datasets espaciales que incluyen los barrios y las manzanas de la ciudad.

```{r}
barrios <- st_read ("https://raw.githubusercontent.com/MEU-CDPC2/TPS/main/Datasets/barrios.geojson")
manzanas <- st_read ("https://raw.githubusercontent.com/MEU-CDPC2/TPS/main/Datasets/manzanas.geojson")
```

2. *Del mismo portal de datos donde descargaron el shapefile, o de otra fuente si la tienen, elegir un dataset con registros geo-referenciados. Por ejemplo, las escuelas de la ciudad (o las comisarías, o las propiedades en alquiler, etc) con sus coordenadas. Puede ser en formato csv o  shapefile.*

La pandemia generó grandes transformaciones en las formas de habitar nuestras ciudades. En esta linea, a partir de los cambios en los patrones de movilidad, grandes espacios de la trama urbana dedicados al transporte, como los estacionamientos, quedaron en desuso, provocando así grandes vacíos urbanos, particularmente, en las zonas céntricas. De igual manera, la coyuntura puso en evidencia la falta de espacios verdes existente en la CABA. 

Con el fin de construir una solución que permita reconvertir aquellas superficies obsoletas en espacios verdes y así mejorar la calidad de vida de las personas, en este trabajo analizaremos territorialmente la distribución de los estacionamientos urbanos.

A continuación abriremos los datasets de estacionamientos y de espacios verdes.

```{r}
estacionamientos <- read.csv("https://raw.githubusercontent.com/MEU-CDPC2/TPS/main/Datasets/estacionamientos.csv",
                             stringsAsFactors = TRUE,
                             encoding = "UTF-8")
espacioverde <- st_read("https://raw.githubusercontent.com/MEU-CDPC2/TPS/main/Datasets/espacioverdepublico.geojson")
```

3. *Realizar un "join espacial", asignando a cada registro geo-referenciado la unidad geográfica (barrio, comuna, etc) que le corresponda y utilizar ggplot() para realizar lo siguiente:*

Inspeccionamos nuestro dataset principal:

```{r}
head(estacionamientos)
```

```{r}
nrow(estacionamientos)
```

Hay 49 estacionamientos concesionados, de acuerdo a los datos del GCBA.
Como existen missing values en las columnas de barrio y comuna, procederemos a eliminar dichas columnas y refernciar la información de manera espacial. 
Sólo nos quedaremos con las columnas que nos interesan para el análisis.

```{r}
estacionamientos <- estacionamientos %>% 
  #seleccionamos las columnas
  select(long, lat, id, nombre, tipo) %>% 
  #renombramos la columna de longitud, por comodidad
  rename(lon=long) %>% 
  #levantamos el csv espacialmente, tomando los valores de longitud y latitud
  st_as_sf(coords = c("lon", "lat"), crs = 4326)
```

### ¿Cuántos estacionamientos concesionados hay por barrio?

Para saber cuántos estacionamientos concesionados hay por barrio, primero haremos una unión espacial de nuestros datasets.

```{r}
#primero nos aseguramos que ambos datasets se encuentren en el mismo sistema de coordenadas.
barrios <- st_transform(barrios, crs=st_crs(estacionamientos))
estacionamientos <- st_join (estacionamientos, barrios)
```

```{r}
head(estacionamientos)
```

Vemos que se le agregaron las columnas correspondientes a los datos de barrios (barrio, comuna, perímetro, área y geometry)

Paso siguiente, lo agruparemos por barrio y resumiremos por cantidad de estacionamiento. Luego, lo convertiremos en data.frame y eliminaremos la geometría. 

```{r}
estacionamientos_barrio <- estacionamientos %>% 
  group_by(barrio) %>% 
  summarise(cantidad=(n())) %>% 
  st_set_geometry(NULL) %>% 
  as.data.frame()
```

```{r}
head(estacionamientos_barrio)
```

Logramos crear una tabla de datos donde sólo tenemos los nombres de los barrios y la cantidad de estacionamientos concesionados en cada uno de ellos.

Como paso siguiente, uniremos nuevamente nuestro dataset a los datos espaciales de barrios para recuperar la geometría. 

```{r}
estacionamientos_barrio <- left_join(barrios, estacionamientos_barrio, by="barrio")
```

Visualizamos

```{r}
ggplot()+
  geom_bar(data=estacionamientos_barrio %>% filter(cantidad!=0), aes(y=reorder(barrio, -cantidad), weight=cantidad, fill=barrio), show.legend = FALSE)+
  scale_fill_viridis_d()+
  labs(x="Cantidad de estacionamientos concesionados", 
       y="Barrio",
       title="¿Cuáles son los barrios con más estacionamientos en la Ciudad?", 
       caption="Fuente: GCBA")+
  scale_x_continuous(breaks = seq(0, 12, 1))+
  theme_minimal()
```

Mapeamos

```{r}
ggplot()+
  geom_sf(data=barrios, fill="white")+
  geom_sf(data=estacionamientos_barrio %>% filter(cantidad!=0), aes(fill=cantidad), alpha=.5, show.legend = FALSE)+
  geom_sf_text(data=estacionamientos_barrio, aes(label=cantidad), size=4, fontface = "bold")+
  scale_fill_viridis_c()+
  labs(title="¿Cuántos estacionamientos concesionados hay por barrio?",
              caption="Fuente: GCBA")+
  theme_void()+
  theme(plot.title = element_text( hjust = 0.5))
```

En este primer análisis observamos que el área central de la ciudad concentra casi la mitad de los estacionamientos concesionados de la CABA. A continuación, analizaremos esta cuestión con mayor profundidad.

Nuestro primer paso será geolocalizar las manzanas de la Ciudad. Como estas no cuentan con información del barrio en el que se ubican, procederemos a unir los datasets.

```{r}
manzanas <- st_join(manzanas, barrios)
```

Luego, nos quedaremos con las manzanas pertenecientes a los barrios del microcentro porteño (Balvanera, Monserrat y San Nicolas).

```{r}
microcentro <- filter(manzanas, barrio=="MONSERRAT" | barrio=="BALVANERA" | barrio=="SAN NICOLAS")
```

Utilizaremos este último dataset para filtrar los estacionamientos y espacios verdes de la CABA.

```{r}
estacionamientos <- st_intersection(estacionamientos, microcentro)
espacioverde <- st_intersection(espacioverde, microcentro)
```

Y nos quedamos solo con aquellos estacionamientos que sean al nivel de la vereda.

```{r}
estacionamientos<- filter(estacionamientos, tipo!="Estacionamiento Subterráneo")
```

Graficamos

```{r}
ggplot()+
  geom_sf(data = microcentro, fill="grey96")+
  geom_sf(data = espacioverde, fill="springgreen2")+
  geom_sf(data = estacionamientos, aes(color="Estacionamientos"), size=2)+
  scale_color_manual(values = c("Estacionamientos"="blue"))+
  labs(title = "¿Dónde se ubican los estacionamientos del Microcentro porteño?",
       color="",
       subtitle = "",
       caption = "Fuente: BA Data")+
  theme_void()+
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom",
        legend.box.background = element_rect(color = "black"),
        legend.box.margin = margin(3,6,3,6))
```

```{r include=FALSE}
library(hereR)
set_key("pcWH0YNYi1G1eqMvAM7fjHWMvqNOaKL6yprw1aMNCeU")
```

Ahora, analizaremos la ubicación de los estacionamientos en referencia a los espacios verdes y su cobertura. Particularmente, nos centraremos en identificar el rango de manzanas que se puden cubrir a pie en 5 minutos o menos desde un espacio verde.

```{r}
puntosEspaciosVerdes <- map(1:nrow(espacioverde),function(x){st_sample(espacioverde[x,],size=4)})
puntosEspaciosVerdes <- do.call("c",puntosEspaciosVerdes)
puntosEspaciosVerdesSF <- st_as_sf(puntosEspaciosVerdes)
puntosEspaciosVerdesSF <- st_transform(puntosEspaciosVerdesSF,crs=4326)
isocronosEspaciosVerdes <- map(1:nrow(puntosEspaciosVerdesSF),function(x) {cat("Procesando: ",x,"\r")
  isoline(puntosEspaciosVerdesSF[x,], transport_mode = "pedestrian",range_type = "time",range = 60*5)})
isocronosEspaciosVerdesJuntas <- do.call(rbind,isocronosEspaciosVerdes)
isocronosEspaciosVerdesJuntasUnion <-  st_union(isocronosEspaciosVerdesJuntas)
isocronosEspaciosVerdesJuntasUnion <- st_as_sf(isocronosEspaciosVerdesJuntasUnion) %>% 
                                      mutate(cobertura=TRUE)
```

Graficamos

```{r}
ggplot()+
  geom_sf(data = microcentro, fill="grey96")+
  geom_sf(data = espacioverde, fill="springgreen2")+
  geom_sf(data = estacionamientos, aes(color="Estacionamientos"), size=2)+
  geom_sf(data = isocronosEspaciosVerdesJuntasUnion, aes(fill="Cobertura de espacios verdes"), alpha=0.25, color="black")+
  scale_color_manual(values = c("Estacionamientos"="blue"))+
  scale_fill_manual(values = c("Cobertura de espacios verdes"="lightgreen"))+
 labs(title = "¿Cuál es la cobertura de espacios verdes del Microcentro?",
      color="",
      fill="",
      subtitle = "Manzanas a 5 min. o menos de un espacio verde",
      caption = "Fuente: BA Data")+
  theme_void()+
  theme(plot.title = element_text(hjust = 0.5, face="bold"),
        plot.subtitle = element_text(hjust = 0.5),
        legend.position = "bottom",
        legend.box.background = element_rect(color = "black"),
        legend.box.margin = margin(3,6,3,6))
```

Ahora comparemos los estacionamientos, pero utilizando las estaciones de Ecobicis y su cobertura como referencia. Repitamos el proceso.

```{r}
bbox_microcentro <- as.numeric(st_bbox(microcentro))
```

```{r}
mapamicrocentro <- get_stamenmap(bbox = bbox_microcentro,
                          maptype = "toner-lite",
                          zoom=15)
```

```{r}
bicis <- st_read("https://raw.githubusercontent.com/MEU-CDPC2/TPS/main/Datasets/bicis.geojson")
```

```{r}
bicis <- st_intersection(bicis, microcentro)
```

```{r}
isocronosbicis <- map(1:nrow(bicis),function(x) {cat("Procesando: ",x,"\r")
  isoline(bicis[x,], transport_mode = "pedestrian",range_type = "time",range = 60*5)})
isocronosbicisjuntas <- do.call(rbind,isocronosbicis)
isocronosbicisjuntasunion <-  st_union(isocronosbicisjuntas)
isocronosbicisjuntasunion <- st_as_sf(isocronosbicisjuntasunion) %>% 
                                      mutate(cobertura=TRUE)
```

Grafiquemos

```{r}
ggmap(mapamicrocentro)+
  geom_sf(data = microcentro, fill="grey96", inherit.aes = FALSE)+
  geom_sf(data = espacioverde, fill="mediumseagreen", inherit.aes = FALSE)+
  geom_sf(data=bicis, aes(color="Ecobicis"), size=2, inherit.aes = FALSE)+
  geom_sf(data = estacionamientos, aes(color="Estacionamientos"), size=2, inherit.aes = FALSE)+
  geom_sf(data = isocronosbicisjuntasunion, aes(fill="A 5 min o menos a pie de una estación de Ecobicis"), color="coral1", alpha=0.20, color="black", inherit.aes = FALSE)+
  scale_fill_manual(values = c("A 5 min o menos a pie de una estación de Ecobicis"="chocolate2"))+
  scale_color_manual(values = c("Estacionamientos"="blue", "Ecobicis"="orangered"))+
 labs(title = "¿Y si transformamos los estacionamientos del centro porteño en espacios verdes?",
      subtitle = "",
      fill="",
      color="",
      caption = "Fuente: BA Data")+
  theme_void()+
  theme(plot.title = element_text(size= 12, hjust = 0.5,  face="bold"),
        plot.caption=element_text(face = "italic", size=8),
        legend.position = "bottom",
        legend.box.background = element_rect(color = "black"),
        legend.box.margin = margin(3,6,3,6))
```

--------------------------------------------------------------------------------

### <a id="tp_2"></a>**Trabajo Práctico N°2**


```{r include=FALSE}
library(osmdata)
```

**Consignas**

1. *Descargar de OpenStreetMap la grilla de calles para la Ciudad elegida en el ejercicio 1 y mapearla por uno de sus atributos (velocidad mínima, velocidad máxima, cantidad de carriles, etc).*

Primero, creamos la caja de coordenadas de la CABA.

```{r}
bbox_CABA <- getbb("Ciudad Autónoma de Buenos Aires, Argentina")
```

*Nos fijamos que las coordenadas extraídas sean las precisas.*

```{r}
mapa_CABA <- get_stamenmap(bbox = bbox_CABA,
                          maptype = "terrain",
                          zoom=12)
```

```{r}
ggmap(mapa_CABA)+
  theme_void()
```

Segundo, creamos un dataset con las calles de CABA. Para ello:

1º. Consultamos la info disponible.

```{r}
CABA_calles <- opq(bbox_CABA) %>% 
  add_osm_feature(key="highway") 
```

2º. Descargamos la info.

```{r}
CABA_calles <- osmdata_sf(CABA_calles)
```

3º. Seleccionamos solo las líneas y las asignamos a nuestra lista para que se transfome en un dataset.

```{r}
CABA_calles <- CABA_calles$osm_lines
```

Graficamos para ver el resultado

```{r}
ggmap(mapa_CABA)+
  geom_sf(data = CABA_calles, color="deepskyblue4", alpha=0.5, inherit.aes = FALSE)+
  labs(title="Calles de la Ciudad Autónoma de Buenos Aires",
       caption="Fuente: Open Street Map")+
  theme_void()+
  theme(plot.title = element_text(hjust = 0.5))
```

Como vemos, no solo nos descarga las calles de la CABA sino de todo el sistema de coordenadas. Para solucionar ese problema, haremos lo siguiente:

1º Descargamos el límite de la CABA.

```{r}
bbox_CABA_limite <- getbb("Ciudad Autónoma de Buenos Aires, Argentina", format_out = "sf_polygon")
```

```{r}
bbox_CABA_limite <- bbox_CABA_limite$multipolygon
```

```{r}
ggmap(mapa_CABA)+
  geom_sf(data=bbox_CABA_limite, fill=NA, size=1, color="firebrick3", inherit.aes = FALSE)+
  labs(title="Ciudad Autónoma de Buenos Aires",
       caption="Fuente: Open Street Map")+
  theme_void()
```

2º Intersectamos nuestro dataset de calles con el del límite.

```{r}
CABA_calles <- st_intersection(CABA_calles, bbox_CABA_limite)
```

Graficamos

```{r}
ggmap(mapa_CABA)+
  geom_sf(data=bbox_CABA_limite, fill=NA, size=1, color="firebrick3", inherit.aes = FALSE)+
  geom_sf(data = CABA_calles, color="deepskyblue4", alpha=0.5, inherit.aes = FALSE)+
  labs(title="Calles de la Ciudad Autónoma de Buenos Aires",
       caption="Fuente: Open Street Map")+
  theme_void()+
  theme(plot.title = element_text(hjust = 0.5))
```

Por último, coloreamos nuestras calles de acuerdo a la velocidad máxima permitida.

```{r}
CABA_calles <- mutate(CABA_calles, maxspeed= fct_relevel(maxspeed, "5", "10", "20", "30", "40", "50", "60", "70", "80", "90", "100", "130"))

ggmap(mapa_CABA)+
  geom_sf(data = filter(CABA_calles, !(is.na(maxspeed))), aes(color=maxspeed), fill=NA, inherit.aes = FALSE)+
  scale_color_viridis_d()+
    labs(title="Calles de la Ciudad Autónoma de Buenos Aires",
       color="Velocidad máxima (KM/H)",
       caption="Fuente: Open Street Map")+
  theme_void()

```

2. *Descargar de OpenStreetMap una (o más) capas de datos de tipo puntos o polígonos. (Ver catálogo de categorías en https://wiki.openstreetmap.org/wiki/Map_Features)*
*2. a. Proyectar los datos descargados en un mapa y comentar los resultados: ¿Cómo se distribuyen en la Ciudad?*

En línea con nuestro trabajo anterior, procederemos a descargar los estacionamientos de la CABA.

```{r}
parking_CABA_OSM <- opq (bbox_CABA) %>% 
  add_osm_feature(key="building", value="parking")
parking_CABA_OSM <- osmdata_sf(parking_CABA_OSM)
parking_CABA_OSM <- parking_CABA_OSM$osm_points
```

Graficamos para ver su ubicación.

```{r}
ggmap(mapa_CABA)+
  geom_sf(data = parking_CABA_OSM, aes(color="Estacionamientos"), inherit.aes = FALSE)+
  scale_color_manual(values = c("Estacionamientos"="red2"))+
    labs(title="Ciudad Autónoma de Buenos Aires",
       color="Referencias",
       caption="Fuente: Open Street Map")+
  theme_void()
```

Al igual que hicimos con las calles, nos quedaremos unicamente con los estacionamientos que se encuentren dentro de la CABA.

```{r}
parking_CABA_OSM <- st_intersection(parking_CABA_OSM, bbox_CABA_limite)
```

Nos quedamos solo con los valores únicos.

```{r}
parking_CABA_OSM <- unique(parking_CABA_OSM)
```

Graficamos para ver los resultados

```{r}
ggmap(mapa_CABA)+
  geom_sf(data = parking_CABA_OSM, aes(color="Estacionamientos"), inherit.aes = FALSE)+
  scale_color_manual(values = c("Estacionamientos"="red2"))+
    labs(title="Ciudad Autónoma de Buenos Aires",
       color="Referencias",
       caption="Fuente: Open Street Map")+
  theme_void()
```

Al ver el mapa anterior, podemos observar que hay algo que no anda bien. Nuestro dataset de estacionamientos contiene 87 registros, aunque sólo aparecen geolocalizados unos pocos puntos. Ello puede deberse a que la posición de los mismos está mal cargada.

No obstante, en Open Street Maps es posible encontrar que los estacionamientos se encuentran divididos en múltiples categorías. Probemos con otra categoría mucho más amplia que la original y repitamos el proceso:

```{r}
parking_CABA_OSM_B <- opq (bbox_CABA) %>% 
  add_osm_feature(key="amenity", value="parking")
parking_CABA_OSM_B <- osmdata_sf(parking_CABA_OSM_B) 
parking_CABA_OSM_B <- parking_CABA_OSM_B$osm_points
```

```{r}
parking_CABA_OSM_B <- st_intersection(parking_CABA_OSM_B, bbox_CABA_limite)
```

```{r}
parking_CABA_OSM_B <- unique(parking_CABA_OSM_B)
```

Grafiquemos

```{r}
ggmap(mapa_CABA)+
  geom_sf(data = parking_CABA_OSM_B, aes(color="Estacionamientos"), inherit.aes = FALSE)+
  scale_color_manual(values = c("Estacionamientos"="red2"))+
    labs(title="Ciudad Autónoma de Buenos Aires",
       color="Referencias",
       caption="Fuente: Open Street Map")+
  theme_void()
```

Como podemos ver en el mapa anterior, la mayor concentración de estacionamientos se da en el corredor que se extiende desde el centro de la CABA hacia el norte. No obstante, es importante reconocer que los estacionamientos se muestran distribudios a lo largo y ancho de la ciudad.

2. b. *Hacer un conteo de los ítems de la capa descargada por barrio, mapearlo y compararlo con el conteo de los ítems descargados en el ejercicio anterior: ¿La distribución es similar o hay diferencias? ¿A qué se puede deber?*

Ahora, crucemos nuestro dataset de estacionamientos con el de barrios para conocer su distribución por cada uno de estos.

```{r}
parking_CABA_OSM_B <- st_transform(parking_CABA_OSM_B, crs = st_crs(barrios))
```

```{r}
parking_CABA_OSM_B <- st_join(parking_CABA_OSM_B, barrios)
```

Agrupemos los casos por barrio.

```{r}
parking_CABA_OSM_barrio <- parking_CABA_OSM_B %>% 
  group_by(barrio) %>% 
  summarise(Q_estacionamientos=(n())) %>% 
  st_set_geometry(NULL) %>% 
  as.data.frame() %>% 
  filter(!is.na(barrio))
```

Grafiquemos.

```{r fig.height=10}
ggplot()+
  geom_bar(data=parking_CABA_OSM_barrio %>% filter(Q_estacionamientos !=0), aes(y=reorder(barrio, -Q_estacionamientos), weight=Q_estacionamientos, fill=barrio), show.legend = FALSE)+
  scale_fill_viridis_d()+
  labs(x="Cantidad de estacionamientos", 
       y="Barrio",
       title="¿Cuántos estacionamientos por barrio existen en la CABA \n\ según OSM?", 
       caption="Fuente: OSM")+
  scale_x_continuous(breaks = seq(0, 500, 50))+
  theme_minimal()
```

```{r}
parking_CABA <- left_join(barrios, parking_CABA_OSM_barrio, by="barrio")
```

Visualizamos

```{r}
ggplot()+
  geom_sf(data=barrios, fill="white")+
  geom_sf(data=parking_CABA %>% filter(Q_estacionamientos!=0), aes(fill=Q_estacionamientos), alpha=.5, show.legend = FALSE)+
  geom_sf_text(data=parking_CABA, aes(label=Q_estacionamientos), size=4, fontface = "bold")+
  scale_fill_viridis_c()+
  labs(title="¿Cuántos estacionamientos concesionados hay por barrio según OSM?",
              caption="Fuente: OSM")+
  theme_void()+
  theme(plot.title = element_text( hjust = 0.5))
```

Comparemoslo con nuestro GEOJSON original.

```{r}
ggplot()+
  geom_sf(data=barrios, fill="white")+
  geom_sf(data=estacionamientos_barrio %>% filter(cantidad!=0), aes(fill=cantidad), alpha=.5, show.legend = FALSE)+
  geom_sf_text(data=estacionamientos_barrio, aes(label=cantidad), size=4, fontface = "bold")+
  scale_fill_viridis_c()+
  labs(title="¿Cuántos estacionamientos concesionados hay por barrio?",
              caption="Fuente: GCBA")+
  theme_void()+
  theme(plot.title = element_text( hjust = 0.5))
```

La primer observación que obtenemos es que nuestro N aumento considerablemente. Luego, si bien la mayor concentración de estacionamientos se da en el eje Centro - Norte de la CABA (siendo Palermo el principal barrio ahora), existe una oferta cosiderable en barrios perífericos como Lugano, Caballito, La Boca, Flores y Villa Soldati.

Estas diferencias pueden deverse a varios factores. Sin embargo, es importante reconocer que, mientras nuestro GEOJSON original nos daba sólo la ubicación de los estacionamientos concesionados, el nuevo dataset con datos de OSM ofrece información de todos los tipos de estacionamientos existentes en la CABA.

Veamos las diferencias con mayor precisión:

```{r}
estacionamientos_barrio[is.na(estacionamientos_barrio)] <- 0

parking_OSM_GCBA <- left_join(parking_CABA_OSM_barrio, estacionamientos_barrio, by="barrio") %>% 
  rename("cantidad_GCBA"="cantidad") %>% 
  group_by(barrio, Q_estacionamientos, cantidad_GCBA) %>%
  summarise(diferencia= Q_estacionamientos-cantidad_GCBA)
```

```{r}
head(parking_OSM_GCBA, y=reorder(barrio, -diferencia))
```

```{r fig.height=10}
ggplot()+
  geom_bar(data=parking_OSM_GCBA, aes(y=reorder(barrio, -Q_estacionamientos), weight=Q_estacionamientos, fill=barrio), show.legend = FALSE)+
  geom_bar(data=parking_OSM_GCBA, aes(y=reorder(barrio, -Q_estacionamientos), weight=cantidad_GCBA, fill=barrio), fill="red", show.legend = FALSE)+
  scale_fill_viridis_d()+
  labs(x="Diferencia (cantidad de estacionamientos)", 
       y="Barrio",
       title="¿Cuánto difieren los datos de OSM con respecto a los del GCBA?", 
       caption="Fuente: GCBA + OSM",
       fill="Estacionamientos GCBA")+
  scale_x_continuous(breaks = seq(0, 500, 50))+
  theme_minimal()
```

Mapeamos las diferencias para el área del Microcentro porteño.

```{r}
parking_microcentro <- parking_CABA_OSM_B %>% 
  filter(barrio=="MONSERRAT" | barrio=="BALVANERA" | barrio=="SAN NICOLAS") %>% 
  filter(parking!="underground" | layer!="-1")
```

```{r}
ggplot()+
  geom_sf(data = microcentro, fill="grey96")+
  geom_sf(data = espacioverde, fill="springgreen2")+
  geom_sf(data = estacionamientos, aes(color="Estacionamientos GCBA"), size=2, alpha=0.5)+
  geom_sf(data=parking_microcentro, aes(color="Estacionamientos OSM"), size=2, alpha=0.5)+
  scale_color_manual(values = c("Estacionamientos GCBA"="blue", "Estacionamientos OSM"="red"))+
  labs(title = "¿Dónde se ubican los estacionamientos del Microcentro porteño \n según las distintas fuentes?",
       color="",
       subtitle = "",
       caption = "Fuente: BA Data")+
  theme_void()+
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom",
        legend.box.background = element_rect(color = "black"),
        legend.box.margin = margin(3,6,3,6))
```

Como podemos observar, las diferencias entre los datos provistos por el GEOJSON y los datos recolectados por OSM divergen considerablemente. Esto es así de tal manera que ambos sets de datos sólo coinciden en la ubicación de dos estacionamientos.


--------------------------------------------------------------------------------


### <a id="tp_3"></a>**Trabajo Práctico N°3**


```{r include=FALSE}
library(lubridate)
```

*Consignas*

1. *Utilizar algún dataset open data de la Ciudad con la que están trabajando que tenga tanto coordenadas como fechas.*

En esta parte del trabajo, retomaremos el análisis de las ecobicis y los viajes realizados en el área central de la Ciudad de Buenos Aires. Ello nos permitirá estudiar con mayor precisión el nivel de movilidad en el área durante la pandemia y hacer suposiciones sobre como podría impactar la promoción de nuevos espacios verdes en la zona.

Con este fin, utilizaremos el datset de viajes en bicicleta del año 2020: 

*ACLARACIÓN: Debido al tamaño del dataset original y su imposibilidad de subirlo a github, optamos por utilizar una versión más pequeña que solo contiene los viajes iniciados en estaciones del Microcentro porteño.*  

```{r}
bicis_2020 <- read_csv("https://raw.githubusercontent.com/MEU-CDPC2/TPS/main/Datasets/bicis_microcentro.csv")
```

2. *Análisis Temporal: Realizar al menos 1 gráfico que les permita analizar la temporalidad de los datos. ¿Detectan algún patrón temporal? ¿A qué puede deberse?*.  

```{r}
str(bicis_2020)
```

Como podemos ver, nuestro dataset ya cuenta con los registros de fecha y hora en su formato correspondiente, por lo que ya podemos trabajar sobre los datos.

A fin de lograr una mayor precisión temporal, realizaremos algunas otras modificaciones al dataset.  

-   1º. Identificamos el día y el mes en el que se realizó cada viaje.  

```{r}
bicis_2020 <- bicis_2020 %>% 
  mutate(dia = wday(fecha_origen_recorrido, label = TRUE, abbr = FALSE),
         mes = month(fecha_origen_recorrido, label = TRUE, abbr = FALSE))
```

-   2º. Creamos una columna que contenga la hora de inicio de cada viaje.

```{r}
bicis_2020 <- bicis_2020 %>% 
  mutate(hora = hour(fecha_origen_recorrido))
```

-   3º. Calculamos la duración de cada recorrido.

```{r}
head(bicis_2020)
```

Como vemos, la columna "duración_recorrido" ya cuenta con la información, pero expresada en segundos. Por lo tanto, sólo nos limitaremos a traducirla en minutos.

```{r}
bicis_2020 <- bicis_2020 %>%
  mutate(duracion_minutos = round(as.numeric(as.duration(duracion_recorrido), "minutes"),2)) 
```
  
**¿Cúantos minutos duran los viajes en bicicleta iniciados en el microcentro en promedio?**

```{r}
paste(round(mean(bicis_2020$duracion_minutos),2), " minutos es el promedio de duracion de viajes. Sin embargo, la mediana está en ", round(median(bicis_2020$duracion_minutos),2), " minutos, por lo que reconocemos que la distribución de los datos tiene una cola hacia la derecha")
```

Ahora, grafiquemos para ver como se distribuyen los viajes según su duración-

```{r}
ggplot(bicis_2020, aes(duracion_minutos)) +
  geom_histogram(bins=50, fill="orange", alpha=.5, color="black")+
  labs(x="Duración en minutos", 
       y="Cantidad de viajes",
       title="¿Cómo es la distribución de viajes según su duración?", 
       subtitle = "Expresado en escala logarítica",
       caption="Fuente: GCBA")+
  scale_y_log10()+
  scale_x_log10()+
  theme_minimal()
```

Notamos la presencia de valores extremos, tanto superiores como inferiores. Esto puede deberse, por ejemplo, a una falla en la aplicación, o a usuarios que desbloquearon una bicicleta y la devolvieron instáneamente. Un análisis profundo sobre la duración de los viajes debería contemplar la limpieza de dichos outliers y trabajar exclusivamente con valores representativos. 

#### ¿Cómo fue la distribución a lo largo del año? ¿Se reconoce el impacto de la pandemia en el comportamiento de los usuarios?

```{r}
#Como no se registraron viajes en el mes de Abril, agregaremos una instancia vacía

abril  <-  data.frame(mes=as.Date("2020-04-01")) %>% 
  mutate(mes = month(mes, label = TRUE, abbr = FALSE))

bicis_2020 <- full_join(bicis_2020, abril, by="mes")
```


```{r}
ggplot(bicis_2020) + 
  geom_bar(aes(x = mes), fill="orange", alpha=.5, color="black") +
  scale_y_continuous(limit = c(0, 20000), breaks = seq(0, 20000, 5000))+
  labs(title = "Cantidad de viajes en bicicleta en el Microcentro",
       subtitle = "Año 2020",
       x = "Mes",
       y = "Viajes",
       caption = "ACLARACIÓN: En Abril no se produjeron viajes \n\ Fuente: BA Data")+
  theme_minimal()+
  theme(axis.text.x = element_text(face="bold", size = 7))
```

La caída durante los primeros meses de cuarentena resulta evidente, a tal punto que el mes de Abril no registra viajes.
Curiosamente, a partir del mes de agosto (a 5 meses de haber arrancado la cuarentena), el volumen de viajes en bicicleta en el microcentro porteño supera al valor de enero, el máximo en el año previo al inicio de la pandemia. Sin embargo, ello no quiere decir que más gente use la bicicleta que en niveles pre pandemicos. Es importante mencionar que, año tras año, durante los primeros meses del calendario, la circulación en esta área geografica se reduce significativamente en comparación con su volumen habitual del resto del ciclo anual. Por ello, para poder llegar a una conclusión más profunda sobre los parámetros de uso, debiese de compararse la información con la del año 2019 (a los fines de este trabajo, omitiremos este paso por el momento).

Veamos que sucede a lo largo de las días de la semana.

```{r}
ggplot(bicis_2020) + 
  geom_bar(aes(x = dia), fill="orange", alpha=.5, color="black") +
  scale_y_continuous(limit = c(0, 20000), breaks = seq(0, 20000, 5000))+
  labs(title = "Cantidad de viajes en bicicleta en el Microcentro",
       subtitle = "Año 2020",
       x = "Día",
       y = "Viajes",
       caption = "Fuente: BA Data")+
  theme_minimal()
```

La distribución de viajes por día marca un claro contraste entre los días de semana y los fin de semanas. Es en los primeros donde se observa un mayor nivel de viajes, a un volumen similar en cada uno de los 5 días.

Repitamos el mismo análisis, pero por horas.

```{r}
ggplot(bicis_2020)+
  geom_bar(aes(x = hora), fill="orange", alpha=.5, color="black") +
  scale_x_continuous(limit = c(-1, 24), breaks = seq(0, 23, 1))+
  labs(title = "Cantidad de viajes en bicicleta en el Microcentro",
       subtitle = "Año 2020",
       x = "Horas",
       y = "Viajes",
       caption = "Fuente: BA Data")+
  theme_minimal()
```

Durante el día, el mayor volumen de viajes en bicicleta ocurre a las 12 hs. y se mantiene en niveles similares hasta las 16 hs., cuando comienza a decaer. Como contrapartida, el mínimo volumen se registra entre 3 y 4 de la mañana. 

3. *Análisis Espacial: Analizar la distribución espacial de los datos a partir de al menos 1 mapa de densidad que muestre donde se concentran la mayor cantidad de observaciones. Comparar la densidad de los datos en el tiempo (facetar). ¿Los patrones espaciales de los datos elegidos se mantienen o varían en el tiempo?*

Ahora veamos las estaciones de bicicleta que más fueron utilizadas en el microcentro durante los meses de la pandemia.

```{r}
ggmap(mapamicrocentro) +
  geom_sf(data=microcentro, aes(fill=MANZANA), fill="gray", alpha=.5, show.legend = FALSE, inherit.aes = FALSE)+
  stat_density_2d(data = bicis_2020, 
                  aes(x = lon, y = lat, 
                      fill = stat(level)), alpha = 0.6, geom = "polygon", contour = TRUE) +
  labs(title="Estaciones de ecobicis en el microcentro",
       subtitle="Año 2020",
       caption= "Fuente: BA Data",
       fill="Cantidad de usos")+
  theme_void()+
  scale_fill_viridis_c(option="magma", direction=-1, alpha=.6)+
  theme(plot.title = element_text(hjust = 0.2),
        plot.subtitle = element_text(size = 11, hjust = 0.1),
        legend.title = element_text(size=9))
```

El gráfico  muestra que durante el 2020 se utilizaron más las estaciones de ecobicis del lado oeste de la Av. 9 de Julio que en la city porteña (algo que a simple vista se correlaciona con los usos de suelos algo direfentes entre ambos sectores del Microcentro). En ese sentido, es particularmente notable la importancia de la estación de Congreso.

Cabe descatar que no se genera un mapa de calor uniforme que cubra toda la superficie porque el agrupamiento de datos puntuales se da pares de coordenadas distantes entre sí (correspondientes a las estaciones).

Ahora veamos como fue la intensidad de usos a lo largo de los meses.

```{r}
ggmap(mapamicrocentro) +
  geom_bin2d(data = bicis_2020, aes(x = lon, y = lat), bins=7, alpha=.7)+
  scale_fill_viridis_c()+  
  labs(title="Estaciones de ecobicis en el microcentro",
       subtitle="Año 2020",
       caption= "ACLARACIÓN: En Abril no se produjeron viajes \n\ Fuente: BA Data",
       fill="Cantidad de usos")+
  facet_wrap(~mes)+
  theme_void()+ 
  theme(plot.title = element_text(hjust = 0.1),
        plot.subtitle = element_text(size = 11, hjust = 0.05),
        legend.title = element_text(size=9))
```

Al desagregar los datos por mes, notamos que la alta frecuencia de usos de bicis en la estación de Congreso se corresponden principalmente con el mes de Noviembre, momento en el cual se produjeron el mayor uso de las estaciones de ecobicis en el Microcentro.

A su vez, resulta interesante observar como, a medida que los contagios retroceden, las restricciones disminuyen y la actividad aumenta, incrementa el uso de las estaciones de ecobicis. Sin embargo, se muestra un claro clivaje entre las estaciones al oeste de la Av. 9 de Julio y las de la city porteña. Mientras que las primeras muestran un incremento paulatino en la actividad a través de los meses, las segundas parecen mantener un grado de actividad (bajo) a lo largo de todo año.

En este marco, la provisión de nuevos espacios verdes en el microcentro porteño puede resultar en un foco de atracción para las personas y traer mayor dinamismo al área deprimida.

--------------------------------------------------------------------------------


### <a id="tp_4"></a>**Trabajo Práctico N°4**


```{r include=FALSE}
library(rtweet)
```


Previo a realizar cualquier intervención sobre el Microcentro, debemos indagar sobre la opinión que tienen porteños sobre de la oferta actual de espacios públicos verdes en la ciudad. Por este motivo, el siguiente trabajo se propone realizar un análisis de redes a fin de identificar las principales tendencias de la opinión pública en lo respectivo a los espacios verdes del distrito, y, particularmente, los de su área central. 

*CONSIGNAS*

1. *Descargar tweets que se originen en los alrededores de la Ciudad con la que están trabajando.*

Nuestro primer paso será descargar los tweets originales emitidos en la CABA que contengan las palabras "espacio verde" en cualquier parte de su estructura. Para delimitar el área, seleccionamos las coordenadas del parque Centenario y establecemos un radio de 6,5 millas, la distancia que existe en promedio al borde del distrito.

```{r}
tweets_verdes <- search_tweets(q="espacios+verdes", 
                               n=100000, 
                               geocode = "-34.606022,-58.433788,6.5mi", 
                               include_rts = FALSE,
                               retryonratelimit = TRUE)

```

Repetimos el proceso para la palabra "espacio público".

```{r}
tweets_publicos <- search_tweets(q = "espacio+público",
                                 n = 100000,
                                 geocode = "-34.606022,-58.433788,6.5mi",
                                 include_rts = FALSE,
                                 retryonratelimit = TRUE)
```

Si bien hicimos la consulta por 100000 tweets de la última semana, notamos que para ambos búsquedas sólo obtuvimos un 1% de la cantidad pedida. Esto nos demuestra que son temas poco mencionados en twitter al momento del análisis.   

Unimos ambos datasets.

```{r}
tweets <- union_all(tweets_verdes, tweets_publicos)
```

```{r}
cat("La cantidad de tweets obtenida para cada una de las búsquedas fue:\n") 
paste("Espacios verdes: ", length(tweets_verdes))
paste("Espacio público: ", length(tweets_publicos))
```

2. *Realizar las siguientes consignas:*  

a. *¿Cómo se distribuye la popularidad de los usuarios? ¿Quiénes son los 5 que más seguidores tienen? Graficar.*

Ahora veremos la popularidad de los twiteros en cuestión.

```{r}
ggplot(tweets) +
  geom_histogram(aes(x = followers_count), fill="orange", alpha=.5, color="black")+
  scale_y_continuous(limit = c(0, 90), breaks = seq(0, 90, 10))+
  labs(title = "Cantidad de cuentas de twitter",
       subtitle = "Por seguidores",
       y="Cuentas",
       x="Seguidores",
       caption = "Fuente: Twitter")+
  theme_minimal()
```

A simple vista, la gran mayoría de los twitteros poseen solo un puñado de seguidores. Pero tambien reconocemos la presencia de unos pocos usuarios que acumula una gran cantidada de seguidores.    

Veamos con mayor profundidad.

Obtenemos un top 10 de los usuarios más populares.

```{r}
tweets %>% 
  select(screen_name, followers_count) %>% 
  distinct() %>% 
  arrange(desc(followers_count)) %>% 
  top_n(10)
```

De nuestra muestra, vemos que el usuario más popular es el GCBA, seguido, en su mayoría, por medios periodísticos y periodistas.

En esta línea, veamos el tweet más popular y su contenido.

```{r}
tweets %>%
  select(screen_name, text, retweet_count) %>%
  distinct() %>% 
  arrange(desc(retweet_count)) %>% 
  head(10)
```


Al observar nuestros datos, podemos ver que los tweets seleccionados poseen un volumen relativamente bajo de retweets. Curiosamente, los tweets más populares de nuestras muestra no fueron escritos por ninguna de las 5 cuentas más populares anteriormente mencionadas.  

Luego, en cuanto al contenido, los tweets parecen dividirse en dos grupos: aquellos que expresan una posición crítica frente a la gestión del GCBA en cuanto a los espacios verdes de la ciudad, y aquellos que refieren a otras cuestiones que poco tienen que ver con la oferta de estos lugares.
  

b. *¿En qué momento del día se realiza la mayor cantidad de tweets? Graficar.*

Ahora veremos a qué hora se twittea con mayor intensidad sobre los temas de interés. 


```{r}
tweets %>%
  count(hora = hour(with_tz(created_at, "America/Argentina/Buenos_Aires"))) %>% 
  ggplot() +
  geom_col(aes(x = hora, y = n), fill="orange", alpha=.5, color="black")+
  scale_y_continuous(limit = c(0, 12), breaks = seq(0, 12, 2))+
  scale_x_continuous(limit = c(-1, 24), breaks = seq(0, 23, 1))+
  labs(title = "Cantidad de tweets",
       subtitle = "Por horas del día",
       y="Tweets",
       x="Horas",
       caption = "Fuente: Twitter")+
  theme_minimal()+
  geom_smooth(aes(x = hora, y = n), color="brown4", linetype="dashed", method = "loess", se=FALSE)
```

Podemos ver que la gente twittea más a medida que avanza el día, y llega a un pico de actividad en la mitad de la tarde (entre las 16 y 17 hs). A partir de allí comienza a caer la actividad, con otro pico registrado a las 22hs.

c. *Aislando los tweets que poseen coordenadas geográficas (lat y long), crear al menos 1 mapa que muestre posición de los tweets y cantidad de seguidores del usuario que tuitea.*

Ahora bien, veamos desde donde twittean los usuarios que hablan sobre nuestra temática de interés. Para eso:

1º. Extraemos las coordenadas de nuestros tweets

```{r}
tweets_geo <- lat_lng(tweets)
```

Filtramos para solo quedarnos con los tweets que tienen coordenadas precisas.

```{r}
tweets_geo <- tweets_geo %>% 
    filter(!is.na(lat), !is.na(lng))
```

Graficamos

```{r}
leaflet(tweets_geo) %>% 
    addTiles() %>% 
    addMarkers(popup = ~paste("user:", screen_name,
                              "followers", followers_count,
                              "tweet:", text),
               lat = ~jitter(lat, 50),
               lng = ~jitter(lng, 50))
```

Como conclusión, llama la atención la poca relevancia que parece tener la temática de los espacios verdes públicos en Twitter, a pesar de ser un tema de actualidad y suma importancia. Las consultas realizadas no arrojaron una cantidad de resultados suficientes como para entender la opinión popular. Es probable que al momento del análisis la agenda twittera haya estado ocupada con otros temas de interés, como la vacunación de COVID-19 o el fútbol.

